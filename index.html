<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>LPO ‚Äì Edu Bacci</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0b0e14">
<link rel="apple-touch-icon" href="icon-512.png">
<style>
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:#0b0e14;color:#eaeef5}
  header{position:sticky;top:0;background:#121826;border-bottom:1px solid #22304a;padding:14px 16px;z-index:2}
  h1{font-size:18px;margin:0}
  main{max-width:1000px;margin:0 auto;padding:16px}
  .tabs{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap}
  .tab{border:1px solid #2a3b5e;background:#0f1420;color:#eaeef5;border-radius:999px;padding:8px 12px;cursor:pointer}
  .tab.active{background:#2663ff;border-color:#2663ff}
  .quick{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap}
  .qbtn{background:#0f1420;border:1px dashed #2a3b5e;color:#eaeef5;border-radius:8px;padding:6px 10px;cursor:pointer}
  .card{background:#121826;border:1px solid #22304a;border-radius:12px;padding:14px;margin:14px 0}
  .grid{display:grid;gap:10px}
  .grid-2{grid-template-columns:1fr 1fr}
  .grid-3{grid-template-columns:1fr 1fr 1fr}
  label{font-size:12px;color:#9fb3c8}
  input[type=number],input[type=date],select,textarea{width:100%;padding:10px;border-radius:8px;border:1px solid #2a3b5e;background:#0f1420;color:#eaeef5}
  textarea{min-height:110px}
  .btn{display:inline-flex;align-items:center;gap:8px;background:#2663ff;color:#fff;border:0;border-radius:10px;padding:10px 14px;font-weight:600;cursor:pointer}
  .btn.ghost{background:#0f1420;border:1px solid #2a3b5e}
  .muted{color:#9fb3c8;font-size:12px}
  details{background:#0f1420;border:1px solid #22304a;border-radius:10px;margin:8px 0;overflow:hidden}
  details>summary{cursor:pointer;list-style:none;padding:12px 14px;font-weight:700}
  details>summary::-webkit-details-marker{display:none}
  table{width:100%;border-collapse:collapse;margin:8px 0;border-radius:8px;overflow:hidden;min-width:860px}
  th,td{border-bottom:1px solid #22304a;padding:8px;text-align:left;font-size:14px;vertical-align:middle}
  th{background:#101726}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .right{margin-left:auto}
  .pill{border:1px solid #2a3b5e;padding:2px 8px;border-radius:999px;font-size:12px;color:#9fb3c8;margin-right:6px}
  .timer{font-variant-numeric:tabular-nums}
  .hide{display:none}
  .done{background:#1f2940}
  footer{color:#9fb3c8;text-align:center;padding:24px}
</style>
</head>
<body>
<header>
  <h1>LPO ‚Äì Edu Bacci</h1>
  <div class="tabs">
    <button id="tab-treino" class="tab active">Treino</button>
    <button id="tab-historico" class="tab">Hist√≥rico</button>
    <button id="tab-config" class="tab">Config 1RM</button>
    <button id="tab-templates" class="tab">Templates</button>
  </div>
  <div class="quick">
    <button id="go-calc" class="qbtn">üßÆ Calculadora 1RM</button>
    <button id="go-templates" class="qbtn">üì¶ Escolher Template</button>
  </div>
  <div class="muted">Interativo ‚Ä¢ offline ‚Ä¢ salva no aparelho. Ajuste cargas, marque feito, RPE, timers e salve a sess√£o.</div>
</header>

<main>
  <!-- CONFIG -->
  <section id="page-config" class="card hide">
    <h3 style="margin:0 0 8px">1RM ‚Üí TM (90%)</h3>
    <div class="grid grid-2">
      <div><label>Snatch (1RM)</label><input type="number" id="sn1" step="0.5" value="50"></div>
      <div><label>Clean & Jerk (1RM)</label><input type="number" id="cj1" step="0.5" value="60"></div>
      <div><label>Front Squat (1RM)</label><input type="number" id="fs1" step="0.5" value="80"></div>
      <div><label>Back Squat (1RM)</label><input type="number" id="bs1" step="0.5" value="134"></div>
      <div><label>Deadlift (1RM)</label><input type="number" id="dl1" step="0.5" value="128"></div>
      <div><label>Bench Press (1RM)</label><input type="number" id="bp1" step="0.5" value="99"></div>
      <div><label>Overhead Press (1RM)</label><input type="number" id="oh1" step="0.5" value="64"></div>
    </div>
    <div class="row" style="margin-top:12px">
      <button class="btn" id="save1rm">Salvar 1RMs</button>
      <span class="pill" id="tmSn"></span><span class="pill" id="tmCj"></span><span class="pill" id="tmFs"></span>
      <span class="pill" id="tmBs"></span><span class="pill" id="tmDl"></span><span class="pill" id="tmBp"></span><span class="pill" id="tmOh"></span>
    </div>
    <div class="muted" style="margin-top:8px">TM = 90% do 1RM. Os pesos do treino se atualizam automaticamente.</div>
  </section>

  <!-- TEMPLATES -->
  <section id="page-templates" class="card hide">
    <h3 style="margin:0 0 8px">Templates de treino</h3>
    <div class="grid grid-2">
      <div>
        <label>Escolha o template</label>
        <select id="planSelect"></select>
      </div>
      <div>
        <label>Descri√ß√£o</label>
        <div id="planDesc" class="muted">Selecione um plano para ver a descri√ß√£o.</div>
      </div>
    </div>
    <div class="row" style="margin-top:10px">
      <button class="btn" id="applyPlan">Aplicar template</button>
      <button class="btn ghost" id="resetPlan">Voltar para padr√£o</button>
      <span class="pill">Plano atual: <b id="planNameNow">‚Äî</b></span>
    </div>

    <hr style="opacity:.2;margin:18px 0">

    <h4 id="calcStart" style="margin:0 0 8px">Calculadora de 1RM</h4>
    <div class="grid grid-3">
      <div>
        <label>Levantamento</label>
        <select id="calcLift">
          <option value="sn">Snatch</option>
          <option value="cj">Clean & Jerk</option>
          <option value="fs">Front Squat</option>
          <option value="bs">Back Squat</option>
          <option value="dl">Deadlift</option>
          <option value="bp">Bench Press</option>
          <option value="oh">Overhead Press</option>
        </select>
      </div>
      <div>
        <label>Peso usado (kg)</label>
        <input type="number" id="calcWeight" step="0.5" value="60">
      </div>
      <div>
        <label>Repeti√ß√µes (1‚Äì10)</label>
        <input type="number" id="calcReps" min="1" max="10" value="3">
      </div>
    </div>
    <div class="grid grid-2" style="margin-top:8px">
      <div>
        <label>F√≥rmula</label>
        <select id="calcFormula">
          <option value="brzycki">Brzycki</option>
          <option value="epley">Epley</option>
        </select>
      </div>
      <div>
        <label>1RM estimada (kg)</label>
        <input type="number" id="calcOut" readonly>
      </div>
    </div>
    <div class="row" style="margin-top:10px">
      <button class="btn" id="calcDo">Calcular</button>
      <button class="btn ghost" id="calcApply">Aplicar ao 1RM</button>
      <div class="muted">Isso vai preencher o 1RM no ‚ÄúConfig 1RM‚Äù, salvar e recalcular as cargas.</div>
    </div>

    <hr style="opacity:.2;margin:18px 0">

    <details>
      <summary>Importar/Exportar template (avan√ßado)</summary>
      <div class="muted" style="margin:8px 0">Cole um JSON no formato do plano e clique em ‚ÄúImportar‚Äù.</div>
      <textarea id="planJSON" placeholder='{"label":"Meu Plano","desc":"...","days":{"d1":[...],"d2":[...]}}'></textarea>
      <div class="row" style="margin-top:8px">
        <button class="btn ghost" id="importPlan">Importar</button>
        <button class="btn ghost" id="exportPlan">Exportar plano atual</button>
      </div>
    </details>
  </section>

  <!-- TREINO -->
  <section id="page-treino">
    <section class="card">
      <div class="row">
        <h3 style="margin:0">Semana 1</h3>
        <span class="pill">Plano: <b id="planNameTreino">‚Äî</b></span>
        <div class="right row">
          <span class="pill">Sess√£o: <span id="sess-timer" class="timer">00:00</span></span>
          <button id="sess-start" class="btn ghost">Iniciar</button>
          <button id="sess-stop" class="btn ghost">Parar</button>
          <button id="sess-reset" class="btn ghost">Zerar</button>
        </div>
      </div>
      <div class="muted">Ao marcar ‚ÄúFeito‚Äù o descanso (90 s) inicia automaticamente (beep no in√≠cio e no fim).</div>

      <!-- D1 -->
      <details open>
        <summary>DIA 1</summary>
        <div class="row">
          <label>Data</label><input type="date" id="date-d1">
          <div class="right row">
            <button class="btn ghost rest" data-secs="60">Descanso 60s</button>
            <button class="btn ghost rest" data-secs="90">90s</button>
            <button class="btn ghost rest" data-secs="120">120s</button>
            <span class="pill">Rest: <span id="rest-d1" class="timer">00:00</span></span>
          </div>
        </div>
        <div style="overflow-x:auto">
          <table>
            <thead><tr><th>#</th><th>Bloco</th><th>Exerc√≠cio</th><th>S√©ries x Reps</th><th>Prescrito (kg)</th><th>Real (kg)</th><th>RPE</th><th>Feito</th><th>Timer</th><th>V√≠deo</th></tr></thead>
            <tbody id="d1"></tbody>
          </table>
        </div>
        <div class="row">
          <button class="btn" data-save-day="d1">Salvar sess√£o (Dia 1)</button>
          <button class="btn ghost" data-markall="d1">Marcar tudo Feito</button>
        </div>
      </details>

      <!-- D2 -->
      <details>
        <summary>DIA 2</summary>
        <div class="row">
          <label>Data</label><input type="date" id="date-d2">
          <div class="right row">
            <button class="btn ghost rest" data-secs="60">Descanso 60s</button>
            <button class="btn ghost rest" data-secs="90">90s</button>
            <button class="btn ghost rest" data-secs="120">120s</button>
            <span class="pill">Rest: <span id="rest-d2" class="timer">00:00</span></span>
          </div>
        </div>
        <div style="overflow-x:auto">
          <table>
            <thead><tr><th>#</th><th>Bloco</th><th>Exerc√≠cio</th><th>S√©ries x Reps</th><th>Prescrito (kg)</th><th>Real (kg)</th><th>RPE</th><th>Feito</th><th>Timer</th><th>V√≠deo</th></tr></thead>
            <tbody id="d2"></tbody>
          </table>
        </div>
        <div class="row">
          <button class="btn" data-save-day="d2">Salvar sess√£o (Dia 2)</button>
          <button class="btn ghost" data-markall="d2">Marcar tudo Feito</button>
        </div>
      </details>

      <!-- D3 -->
      <details>
        <summary>DIA 3</summary>
        <div class="row">
          <label>Data</label><input type="date" id="date-d3">
          <div class="right row">
            <button class="btn ghost rest" data-secs="60">Descanso 60s</button>
            <button class="btn ghost rest" data-secs="90">90s</button>
            <button class="btn ghost rest" data-secs="120">120s</button>
            <span class="pill">Rest: <span id="rest-d3" class="timer">00:00</span></span>
          </div>
        </div>
        <div style="overflow-x:auto">
          <table>
            <thead><tr><th>#</th><th>Bloco</th><th>Exerc√≠cio</th><th>S√©ries x Reps</th><th>Prescrito (kg)</th><th>Real (kg)</th><th>RPE</th><th>Feito</th><th>Timer</th><th>V√≠deo</th></tr></thead>
            <tbody id="d3"></tbody>
          </table>
        </div>
        <div class="row">
          <button class="btn" data-save-day="d3">Salvar sess√£o (Dia 3)</button>
          <button class="btn ghost" data-markall="d3">Marcar tudo Feito</button>
        </div>
      </details>

      <!-- D4 -->
      <details>
        <summary>DIA 4</summary>
        <div class="row">
          <label>Data</label><input type="date" id="date-d4">
          <div class="right row">
            <button class="btn ghost rest" data-secs="60">Descanso 60s</button>
            <button class="btn ghost rest" data-secs="90">90s</button>
            <button class="btn ghost rest" data-secs="120">120s</button>
            <span class="pill">Rest: <span id="rest-d4" class="timer">00:00</span></span>
          </div>
        </div>
        <div style="overflow-x:auto">
          <table>
            <thead><tr><th>#</th><th>Bloco</th><th>Exerc√≠cio</th><th>S√©ries x Reps</th><th>Prescrito (kg)</th><th>Real (kg)</th><th>RPE</th><th>Feito</th><th>Timer</th><th>V√≠deo</th></tr></thead>
            <tbody id="d4"></tbody>
          </table>
        </div>
        <div class="row">
          <button class="btn" data-save-day="d4">Salvar sess√£o (Dia 4)</button>
          <button class="btn ghost" data-markall="d4">Marcar tudo Feito</button>
        </div>
      </details>
    </section>
  </section>

  <!-- HIST√ìRICO -->
  <section id="page-hist" class="hide">
    <section class="card">
      <div class="row">
        <h3 style="margin:0">Hist√≥rico</h3>
        <div class="right row">
          <button class="btn ghost" id="exportCsv">Exportar CSV</button>
          <button class="btn ghost" id="clearHist">Limpar hist√≥rico</button>
        </div>
      </div>
      <div id="hist"></div>
      <div class="muted">Tudo salvo localmente (este aparelho). Depois podemos sincronizar na nuvem.</div>
    </section>
  </section>
</main>

<footer>¬© LPO ‚Äì Edu Bacci. Offline. Dados locais.</footer>

<script>
/* ===== Utils / Estado ===== */
const $ = s => document.querySelector(s);
const today = () => new Date().toISOString().slice(0,10);
const round05 = v => Math.round(v*2)/2;
const perc = (tm, p) => Math.max(0, round05(tm * p));

const saveKey  = 'lpo_tm_v2';
const sessKey  = 'lpo_sessions_v2';
const planKey  = 'lpo_plan_key_v1';
const restTotals = {}; // acumula descanso por dia

/* ===== Atalhos topo ===== */
$('#go-calc').addEventListener('click',()=>{ showTab('templates'); document.getElementById('calcStart').scrollIntoView({behavior:'smooth'}); });
$('#go-templates').addEventListener('click',()=>{ showTab('templates'); });

/* ===== Beep (Web Audio) ===== */
function playBeep(duration=0.25, frequency=880){
  try{
    const ctx = new (window.AudioContext||window.webkitAudioContext)();
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    osc.connect(gain); gain.connect(ctx.destination);
    osc.type='square'; osc.frequency.value=frequency;
    osc.start(); gain.gain.setValueAtTime(1, ctx.currentTime);
    osc.stop(ctx.currentTime+duration);
  }catch(e){/* falha silenciosa */}
}

/* ===== 1RM / TM ===== */
function load1RM(){
  try{const s=JSON.parse(localStorage.getItem(saveKey)||'{}');
    ['sn1','cj1','fs1','bs1','dl1','bp1','oh1'].forEach(id=>{
      const el=document.getElementById(id); if(s[id]!=null && el) el.value=s[id];
    });
  }catch(e){}
}
function getTM(){
  const g=id=>Number($('#'+id)?.value||0)*0.9;
  return {sn:g('sn1'), cj:g('cj1'), fs:g('fs1'), bs:g('bs1'), dl:g('dl1'), bp:g('bp1'), oh:g('oh1')};
}
function showTMs(){
  const {sn,cj,fs,bs,dl,bp,oh}=getTM();
  const set=(id,txt)=>{ const el=$(id); if(el) el.textContent = txt; };
  set('#tmSn','TM Snatch: '+round05(sn)+' kg');
  set('#tmCj','TM C&J: '+round05(cj)+' kg');
  set('#tmFs','TM Front: '+round05(fs)+' kg');
  set('#tmBs','TM Back: '+round05(bs)+' kg');
  set('#tmDl','TM Terra: '+round05(dl)+' kg');
  set('#tmBp','TM Supino: '+round05(bp)+' kg');
  set('#tmOh','TM OHP: '+round05(oh)+' kg');
}
function save1RMData(obj){
  localStorage.setItem(saveKey, JSON.stringify(obj));
  showTMs(); renderAll();
}
$('#save1rm')?.addEventListener('click',()=>{
  const data={}; ['sn1','cj1','fs1','bs1','dl1','bp1','oh1'].forEach(id=>data[id]=Number($('#'+id).value||0));
  save1RMData(data);
});

/* ===== Templates (10 planos) ===== */
const PLANS = {
  /* 1‚Äì2) LPO */
  lpo_base:{label:'LPO ‚Äì Base T√©cnica',desc:'Base t√©cnica + for√ßa moderada (recome√ßo).',
   days:{
    d1:[{blk:'Mobilidade',ex:'Panturrilha/t-spine/Couch',sets:'2‚Äì3 min'},
        {blk:'Aquecimento',ex:'Burgener (Snatch)',sets:'1‚Äì2 voltas',link:'https://www.youtube.com/watch?v=4wLDeeHds58'},
        {blk:'T√©cnico',ex:'Tall Snatch',sets:'5x3',lift:'sn',perc:[0.40,0.55]},
        {blk:'LPO for√ßa',ex:'Overhead Squat',sets:'4x3',lift:'sn',perc:[0.55,0.55]},
        {blk:'For√ßa',ex:'Front Squat',sets:'4x5',lift:'fs',perc:[0.70,0.70]},
        {blk:'Pull',ex:'Snatch High Pull',sets:'4x3',lift:'sn',perc:[0.75,0.75]}],
    d2:[{blk:'T√©cnico',ex:'Clean Pull',sets:'4x3',lift:'cj',perc:[0.85,0.85]},
        {blk:'LPO',ex:'Clean & Jerk (1+2)',sets:'6x',lift:'cj',perc:[0.60,0.60]},
        {blk:'For√ßa',ex:'Back Squat',sets:'5x3',lift:'bs',perc:[0.70,0.70]},
        {blk:'Overhead',ex:'Push Press',sets:'4x4',lift:'cj',perc:[0.70,0.70]}],
    d3:[{blk:'Overhead',ex:'BTN Press',sets:'4x5',lift:'cj',perc:[0.60,0.60]},
        {blk:'Estab.',ex:'Snatch Balance',sets:'5x2',lift:'sn',perc:[0.60,0.60]},
        {blk:'Pull',ex:'Clean High Pull',sets:'4x3',lift:'cj',perc:[0.85,0.85]}],
    d4:[{blk:'Complexo',ex:'Hang Snatch HP + OHS',sets:'6x (2+1)',lift:'sn',perc:[0.55,0.55]},
        {blk:'For√ßa',ex:'Front Squat',sets:'5x3',lift:'fs',perc:[0.725,0.725]},
        {blk:'T√©cnica Jerk',ex:'Push Press BTN',sets:'4x3',lift:'cj',perc:[0.65,0.65]}]
   }},
  lpo_peak:{label:'LPO ‚Äì Pico',desc:'Baixo volume, intensidade alta.',
   days:{
    d1:[{blk:'LPO',ex:'Snatch simples',sets:'6x1',lift:'sn',perc:[0.80,0.85]},
        {blk:'For√ßa',ex:'Front Squat',sets:'4x3',lift:'fs',perc:[0.80,0.85]}],
    d2:[{blk:'LPO',ex:'Clean & Jerk simples',sets:'5x1',lift:'cj',perc:[0.80,0.85]},
        {blk:'For√ßa',ex:'Back Squat',sets:'3x3',lift:'bs',perc:[0.80,0.85]}],
    d3:[{blk:'Overhead',ex:'BTN Press',sets:'4x3',lift:'cj',perc:[0.65,0.70]},
        {blk:'Estab.',ex:'Snatch Balance leve',sets:'3x2',lift:'sn',perc:[0.55,0.60]}],
    d4:[{blk:'LPO',ex:'Power Clean + Jerk',sets:'4x(1+1)',lift:'cj',perc:[0.75,0.80]}]
   }},
  /* 3‚Äì4) Powerbuilding */
  pb_a:{label:'Powerbuilding A',desc:'For√ßa nos compostos + volume de muscula√ß√£o.',
   days:{
    d1:[{blk:'For√ßa',ex:'Back Squat',sets:'5x5',lift:'bs',perc:[0.75,0.80]},
        {blk:'T√©cnico',ex:'Power Snatch',sets:'5x2',lift:'sn',perc:[0.65,0.70]},
        {blk:'Pull',ex:'Snatch Pull',sets:'4x3',lift:'sn',perc:[0.90,0.95]}],
    d2:[{blk:'For√ßa',ex:'Bench Press',sets:'5x5',lift:'bp',perc:[0.75,0.80]},
        {blk:'LPO',ex:'Clean & Jerk',sets:'6x1',lift:'cj',perc:[0.75,0.80]},
        {blk:'Pull',ex:'Clean Pull',sets:'4x3',lift:'cj',perc:[0.95,0.95]}],
    d3:[{blk:'For√ßa',ex:'Deadlift',sets:'5x3',lift:'dl',perc:[0.80,0.85]},
        {blk:'Overhead',ex:'Push Press',sets:'4x6',lift:'cj',perc:[0.65,0.70]}],
    d4:[{blk:'For√ßa',ex:'Front Squat',sets:'4x6',lift:'fs',perc:[0.70,0.75]},
        {blk:'T√©cnico',ex:'Snatch t√©cnica leve',sets:'6x2',lift:'sn',perc:[0.60,0.65]}]
   }},
  pb_b:{label:'Powerbuilding B',desc:'√änfase superior + puxadas pesadas.',
   days:{
    d1:[{blk:'For√ßa',ex:'Back Squat',sets:'4x6',lift:'bs',perc:[0.72,0.77]},
        {blk:'LPO',ex:'Snatch',sets:'6x2',lift:'sn',perc:[0.70,0.75]}],
    d2:[{blk:'For√ßa',ex:'Bench Press',sets:'5x3',lift:'bp',perc:[0.80,0.85]},
        {blk:'Pull',ex:'Clean Pull',sets:'4x3',lift:'cj',perc:[0.90,0.95]}],
    d3:[{blk:'For√ßa',ex:'Deadlift',sets:'5x5',lift:'dl',perc:[0.70,0.80]},
        {blk:'Overhead',ex:'BTN Press',sets:'4x5',lift:'cj',perc:[0.65,0.70]}],
    d4:[{blk:'For√ßa',ex:'Front Squat',sets:'5x5',lift:'fs',perc:[0.72,0.77]},
        {blk:'T√©cnico',ex:'Clean t√©cnica leve',sets:'6x1',lift:'cj',perc:[0.70,0.75]}]
   }},
  /* 5‚Äì6) Powerlifting */
  pl_a:{label:'Powerlifting A',desc:'√änfase em SMR: Squat, Bench, Dead.',
   days:{
    d1:[{blk:'For√ßa',ex:'Back Squat',sets:'5x5',lift:'bs',perc:[0.75,0.80]},
        {blk:'Acess√≥rio',ex:'RDL',sets:'3x6',lift:'dl',perc:[0.60,0.65]}],
    d2:[{blk:'For√ßa',ex:'Bench Press',sets:'5x5',lift:'bp',perc:[0.75,0.80]},
        {blk:'Overhead',ex:'OHP',sets:'4x6',lift:'oh',perc:[0.65,0.70]}],
    d3:[{blk:'For√ßa',ex:'Deadlift',sets:'5x3',lift:'dl',perc:[0.80,0.85]},
        {blk:'Acess√≥rio',ex:'Front Squat leve',sets:'3x5',lift:'fs',perc:[0.60,0.65]}],
    d4:[{blk:'For√ßa',ex:'Back Squat',sets:'3x3',lift:'bs',perc:[0.82,0.87]},
        {blk:'For√ßa',ex:'Bench Press',sets:'3x3',lift:'bp',perc:[0.82,0.87]}]
   }},
  pl_b:{label:'Powerlifting B',desc:'Ondula√ß√µes 3‚Äì5 reps.',
   days:{
    d1:[{blk:'For√ßa',ex:'Back Squat',sets:'4x3',lift:'bs',perc:[0.82,0.87]}],
    d2:[{blk:'For√ßa',ex:'Bench Press',sets:'5x3',lift:'bp',perc:[0.80,0.85]}],
    d3:[{blk:'For√ßa',ex:'Deadlift',sets:'6x2',lift:'dl',perc:[0.82,0.88]}],
    d4:[{blk:'For√ßa',ex:'Front Squat',sets:'4x4',lift:'fs',perc:[0.75,0.80]}]
   }},
  /* 7‚Äì8) Pull‚ÄìPush‚ÄìLegs (adaptado a 4 dias) */
  ppl_a:{label:'PPL A (4 dias)',desc:'Puxar/Empurrar/Pernas + t√©cnico LPO.',
   days:{
    d1:[{blk:'Pull',ex:'Barra fixa / remada',sets:'4x8'},
        {blk:'T√©cnico',ex:'Power Clean',sets:'6x1',lift:'cj',perc:[0.70,0.75]}],
    d2:[{blk:'Push',ex:'Bench Press',sets:'4x6',lift:'bp',perc:[0.72,0.77]},
        {blk:'Overhead',ex:'Push Press',sets:'4x5',lift:'cj',perc:[0.65,0.70]}],
    d3:[{blk:'Legs',ex:'Back Squat',sets:'5x5',lift:'bs',perc:[0.75,0.80]},
        {blk:'T√©cnico',ex:'Snatch t√©cnica',sets:'6x2',lift:'sn',perc:[0.65,0.70]}],
    d4:[{blk:'Pull',ex:'Deadlift',sets:'4x4',lift:'dl',perc:[0.75,0.80]}]
   }},
  ppl_b:{label:'PPL B (4 dias)',desc:'Mais volume em puxadas + LPO moderado.',
   days:{
    d1:[{blk:'Pull',ex:'Remada curvada',sets:'5x8'},
        {blk:'T√©cnico',ex:'Clean Pull',sets:'4x3',lift:'cj',perc:[0.90,0.95]}],
    d2:[{blk:'Push',ex:'OHP',sets:'5x5',lift:'oh',perc:[0.70,0.75]},
        {blk:'Push',ex:'Bench Press',sets:'4x6',lift:'bp',perc:[0.72,0.77]}],
    d3:[{blk:'Legs',ex:'Front Squat',sets:'5x5',lift:'fs',perc:[0.72,0.77]},
        {blk:'T√©cnico',ex:'Snatch Pull',sets:'4x3',lift:'sn',perc:[0.90,0.95]}],
    d4:[{blk:'Pull',ex:'Deadlift',sets:'5x3',lift:'dl',perc:[0.80,0.85]}]
   }},
  /* 9‚Äì10) PHAT */
  phat_a:{label:'PHAT A',desc:'Power Hypertrophy A.',
   days:{
    d1:[{blk:'Power',ex:'Back Squat',sets:'5x3',lift:'bs',perc:[0.82,0.87]},
        {blk:'Power',ex:'Bench Press',sets:'5x3',lift:'bp',perc:[0.82,0.87]}],
    d2:[{blk:'Hypertrophy',ex:'Upper (remo, supino incl.)',sets:'3‚Äì4x10‚Äì12'}],
    d3:[{blk:'Power',ex:'Deadlift',sets:'5x2',lift:'dl',perc:[0.85,0.90]}],
    d4:[{blk:'Hypertrophy',ex:'Lower (agacho hack, leg press)',sets:'3‚Äì4x10‚Äì12'}]
   }},
  phat_b:{label:'PHAT B',desc:'Power Hypertrophy B.',
   days:{
    d1:[{blk:'Power',ex:'Front Squat',sets:'5x3',lift:'fs',perc:[0.80,0.85]}],
    d2:[{blk:'Hypertrophy',ex:'Upper (ombros/tr√≠ceps)',sets:'3‚Äì4x10‚Äì12'}],
    d3:[{blk:'Power',ex:'Bench Press',sets:'5x3',lift:'bp',perc:[0.82,0.87]}],
    d4:[{blk:'Hypertrophy',ex:'Lower (quadr√≠ceps + posterior)',sets:'3‚Äì4x10‚Äì12'}]
   }}
};

function getPlanKey(){ return localStorage.getItem(planKey) || 'lpo_base'; }
function setPlanKey(k){ localStorage.setItem(planKey,k); updatePlanLabels(); renderAll(); }
function getPlan(){ return PLANS[getPlanKey()] || PLANS.lpo_base; }

function fillPlanSelect(){
  const sel = $('#planSelect'); sel.innerHTML='';
  Object.keys(PLANS).forEach(k=>{
    const opt=document.createElement('option');
    opt.value=k; opt.textContent=PLANS[k].label; sel.appendChild(opt);
  });
  sel.value = getPlanKey();
  $('#planDesc').textContent = PLANS[sel.value].desc || '';
}
function updatePlanLabels(){
  const k=getPlanKey();
  const label = (PLANS[k]&&PLANS[k].label)||'‚Äî';
  const a=(id)=>{const el=$(id); if(el) el.textContent=label;};
  a('#planNameNow'); a('#planNameTreino');
}

/* eventos templates */
document.addEventListener('change',e=>{
  if(e.target && e.target.id==='planSelect'){
    const k=e.target.value; $('#planDesc').textContent = (PLANS[k]&&PLANS[k].desc)||'';
  }
});
$('#applyPlan').addEventListener('click',()=>{
  const k=$('#planSelect').value; setPlanKey(k);
  alert('Template aplicado: '+(PLANS[k]&&PLANS[k].label));
  showTab('treino');
});
$('#resetPlan').addEventListener('click',()=>{
  setPlanKey('lpo_base'); fillPlanSelect();
  alert('Template padr√£o (LPO ‚Äì Base T√©cnica) aplicado.');
  showTab('treino');
});
$('#exportPlan').addEventListener('click',()=>{
  $('#planJSON').value = JSON.stringify(getPlan(), null, 2);
  alert('Plano atual exportado para a caixa abaixo.');
});
$('#importPlan').addEventListener('click',()=>{
  try{
    const obj = JSON.parse($('#planJSON').value||'{}');
    if(!obj.label || !obj.days) throw new Error('JSON inv√°lido.');
    const key = 'custom_'+Date.now();
    PLANS[key]=obj;
    fillPlanSelect(); $('#planSelect').value=key; $('#planDesc').textContent=obj.desc||'';
    setPlanKey(key); alert('Template importado e aplicado: '+obj.label);
    showTab('treino');
  }catch(err){ alert('Erro ao importar: '+err.message); }
});

/* Calculadora 1RM */
function calc1RM(weight, reps, formula='brzycki'){
  reps = Math.min(Math.max(1, Number(reps)||1), 10);
  weight = Number(weight)||0;
  return (formula==='epley') ? weight*(1+reps/30) : weight*(36/(37-reps));
}
$('#calcDo').addEventListener('click',()=>{
  const w=Number($('#calcWeight').value||0), r=Number($('#calcReps').value||1), f=$('#calcFormula').value;
  $('#calcOut').value = round05(calc1RM(w,r,f));
});
$('#calcApply').addEventListener('click',()=>{
  const val=Number($('#calcOut').value||0);
  if(!val){ alert('Calcule a 1RM primeiro.'); return; }
  const lift=$('#calcLift').value;
  const map={sn:'sn1',cj:'cj1',fs:'fs1',bs:'bs1',dl:'dl1',bp:'bp1',oh:'oh1'};
  const id=map[lift]; const el=$('#'+id);
  if(!el){ alert('Campo de 1RM n√£o encontrado.'); return; }
  el.value=val;
  const data={}; ['sn1','cj1','fs1','bs1','dl1','bp1','oh1'].forEach(i=>data[i]=Number($('#'+i).value||0));
  save1RMData(data);
  alert('1RM de '+$('#calcLift').selectedOptions[0].text+' atualizado para '+val+' kg. TMs recalculadas.');
  showTab('treino');
});

/* ===== Render do Treino ===== */
function kgText(tm,p){ if(!p) return '‚Äî'; const [a,b]=p; const t1=perc(tm,a), t2=perc(tm,b); return (a===b)? `${t1}` : `${t1} ‚Äì ${t2}`; }
function kgDefault(tm,p){ if(!p) return 0; return perc(tm,p[0]); }

function addCheckboxListeners(dayId, defaultRest=90){
  document.querySelectorAll('#'+dayId+' input[type="checkbox"]').forEach(cb=>{
    cb.addEventListener('change', ()=>{
      const tr = cb.closest('tr');
      if(cb.checked){ tr.classList.add('done'); startRest(dayId, defaultRest); } else { tr.classList.remove('done'); }
    });
  });
}

function renderDay(dayId, arr){
  const tm=getTM(); let html='';
  (arr||[]).forEach((it,idx)=>{
    const base = it.lift? tm[it.lift]||0 : 0;
    const link = it.link? `<a target=_blank href="${it.link}">ver</a>` : '‚Äî';
    html += `<tr data-lift="${it.lift||''}" data-perc="${it.perc?it.perc.join(','):''}">
      <td>${idx+1}</td><td>${it.blk||''}</td><td>${it.ex||''}</td><td>${it.sets||''}</td>
      <td>${it.lift?kgText(base, it.perc):'‚Äî'}</td>
      <td><input type="number" step="0.5" value="${it.lift?kgDefault(base, it.perc):0}"></td>
      <td><select><option value="">‚Äî</option>${[6,7,8,8.5,9,9.5,10].map(v=>`<option>${v}</option>`).join('')}</select></td>
      <td style="text-align:center"><input type="checkbox"></td>
      <td><span class="timer" id="${dayId}-t${idx}">00:00</span>
          <button class="btn ghost start" data-for="${dayId}-t${idx}">‚ñ∂</button>
          <button class="btn ghost stop" data-for="${dayId}-t${idx}">‚è∏</button>
          <button class="btn ghost reset" data-for="${dayId}-t${idx}">‚ü≤</button></td>
      <td>${link}</td>
    </tr>`;
  });
  $('#'+dayId).innerHTML=html;
  addCheckboxListeners(dayId);
}

function renderAll(){
  const PLAN = getPlan();
  updatePlanLabels();
  ['d1','d2','d3','d4'].forEach(d=>{ const el=$('#date-'+d); if(el && !el.value) el.value=today(); });
  renderDay('d1', PLAN.days.d1);
  renderDay('d2', PLAN.days.d2);
  renderDay('d3', PLAN.days.d3);
  renderDay('d4', PLAN.days.d4);
}

/* ===== Timers ===== */
function mkStopwatch(el){
  let t=0, iv=null;
  const fmt=s=>String(Math.floor(s/60)).padStart(2,'0')+':'+String(Math.floor(s%60)).padStart(2,'0');
  const paint=()=>el.textContent=fmt(t);
  return { start(){ if(iv) return; iv=setInterval(()=>{t++;paint();},1000); },
           stop(){ clearInterval(iv); iv=null; },
           reset(){ t=0; paint(); },
           get(){ return t; } };
}
const rowTimers = new Map();
document.addEventListener('click', (e)=>{
  const b=e.target.closest('button'); if(!b) return;
  if(b.classList.contains('start')||b.classList.contains('stop')||b.classList.contains('reset')){
    const id=b.getAttribute('data-for'); const el=document.getElementById(id);
    if(!rowTimers.has(id)) rowTimers.set(id, mkStopwatch(el));
    const sw=rowTimers.get(id);
    if(b.classList.contains('start')) sw.start();
    if(b.classList.contains('stop'))  sw.stop();
    if(b.classList.contains('reset')) sw.reset();
  }
});
const sessSw = mkStopwatch($('#sess-timer'));
$('#sess-start').addEventListener('click',()=>sessSw.start());
$('#sess-stop').addEventListener('click',()=>sessSw.stop());
$('#sess-reset').addEventListener('click',()=>sessSw.reset());

function formatTime(t){ return String(Math.floor(t/60)).padStart(2,'0')+':'+String(Math.floor(t%60)).padStart(2,'0'); }
function startRest(day, secs){
  restTotals[day]=(restTotals[day]||0)+secs;
  const el=$('#rest-'+day); playBeep();
  let t=secs; if(el) el.textContent=formatTime(t);
  const iv=setInterval(()=>{ t--; if(el) el.textContent=formatTime(Math.max(t,0));
    if(t<=0){ clearInterval(iv); playBeep(); } },1000);
}
document.querySelectorAll('.rest').forEach(btn=>{
  btn.addEventListener('click',()=>{
    const secs=Number(btn.dataset.secs||90);
    const day = btn.closest('details').querySelector('tbody').id;
    startRest(day, secs);
  });
});

/* ===== Salvar sess√£o / Hist√≥rico / CSV ===== */
function saveDay(dayId){
  const date = $('#date-'+dayId)?.value || today();
  const tbody = $('#'+dayId);
  const rows=[...tbody.querySelectorAll('tr')];
  let activeSecs=0;
  const itens = rows.map((tr,idx)=>{
    const tds=tr.querySelectorAll('td');
    const realKg=Number(tr.querySelector('input[type=number]').value||0);
    const rpe=tr.querySelector('select').value||'';
    const feito=tr.querySelector('input[type=checkbox]').checked;
    const timerEl = tr.querySelector('span.timer');
    let secs=0; if(timerEl){ const [m,s]=timerEl.textContent.split(':').map(Number); secs=m*60+s; activeSecs+=secs; }
    return { idx:idx+1, bloco:tds[1].innerText, ex:tds[2].innerText, series:tds[3].innerText,
             prescrito:tds[4].innerText, realKg, rpe, feito, activeSecs:secs };
  });
  const rest = restTotals[dayId]||0;
  const sess = { dia:dayId, data:date, tm:getTM(), itens, activeSecs, restSecs:rest, totalSecs:activeSecs+rest, plan:getPlan().label, ts:Date.now() };
  const arr=JSON.parse(localStorage.getItem(sessKey)||'[]'); arr.unshift(sess);
  localStorage.setItem(sessKey, JSON.stringify(arr));
  alert('Sess√£o salva: '+dayId+' ('+date+')\nTempo total: '+formatTime(activeSecs+rest)+' (ativo '+formatTime(activeSecs)+' | descanso '+formatTime(rest)+')');
  renderHistory();
}
document.querySelectorAll('[data-save-day]').forEach(b=>b.addEventListener('click',()=>saveDay(b.dataset.saveDay)));
document.querySelectorAll('[data-markall]').forEach(b=>b.addEventListener('click',()=>{
  const tbody=$('#'+b.dataset.markall);
  tbody.querySelectorAll('input[type=checkbox]').forEach(cb=>{ cb.checked=true; cb.dispatchEvent(new Event('change')); });
}));

function renderHistory(){
  const box=$('#hist'); const arr=JSON.parse(localStorage.getItem(sessKey)||'[]');
  if(!arr.length){ box.innerHTML='<div class="muted">Sem sess√µes salvas ainda.</div>'; return; }
  let html='';
  arr.forEach((s,i)=>{
    const feitos=s.itens.filter(x=>x.feito).length, total=s.itens.length;
    const rpeMed=(s.itens.filter(x=>x.rpe).reduce((a,b)=>a+Number(b.rpe),0)/Math.max(1,s.itens.filter(x=>x.rpe).length)).toFixed(1);
    const nomeDia={d1:'Dia 1',d2:'Dia 2',d3:'Dia 3',d4:'Dia 4'}[s.dia]||s.dia;
    html += `<details ${i===0?'open':''}><summary>${s.data} ‚Ä¢ ${nomeDia} ‚Ä¢ ${s.plan} ‚Äî ${feitos}/${total} feitos ‚Ä¢ RPE ${isNaN(rpeMed)?'‚Äî':rpeMed} ‚Ä¢ ${(s.totalSecs/60).toFixed(1)}min (ativo ${(s.activeSecs/60).toFixed(1)} / descanso ${(s.restSecs/60).toFixed(1)})</summary>
      <div style="overflow-x:auto">
      <table><thead><tr><th>#</th><th>Exerc√≠cio</th><th>S√©ries</th><th>Prescrito</th><th>Real</th><th>RPE</th><th>Feito</th></tr></thead><tbody>`;
    s.itens.forEach(it=>{
      html+=`<tr><td>${it.idx}</td><td>${it.ex}</td><td>${it.series}</td><td>${it.prescrito}</td><td>${it.realKg||'‚Äî'}</td><td>${it.rpe||'‚Äî'}</td><td>${it.feito?'‚úîÔ∏è':'‚Äî'}</td></tr>`;
    });
    html+='</tbody></table></div></details>';
  });
  box.innerHTML=html;
}
$('#exportCsv').addEventListener('click',()=>{
  const arr=JSON.parse(localStorage.getItem(sessKey)||'[]');
  if(!arr.length){ alert('Sem sess√µes para exportar.'); return; }
  const lines=['data,dia,plano,idx,exercicio,series,prescrito,real_kg,rpe,feito,active_secs,rest_secs,total_secs'];
  arr.forEach(s=>s.itens.forEach(it=>lines.push([s.data,s.dia,`"${s.plan}"`,it.idx,`"${it.ex.replace(/"/g,'""')}"`,`"${it.series}"`,`"${it.prescrito}"`,it.realKg,it.rpe||'',it.feito?1:0,it.activeSecs,s.restSecs,s.totalSecs].join(','))));
  const blob=new Blob([lines.join('\n')],{type:'text/csv'}); const a=document.createElement('a');
  a.href=URL.createObjectURL(blob); a.download='lpo-historico.csv'; a.click();
});
$('#clearHist').addEventListener('click',()=>{ if(confirm('Apagar todo o hist√≥rico deste aparelho?')){ localStorage.removeItem(sessKey); renderHistory(); }});

/* ===== Abas ===== */
function showTab(name){
  ['treino','hist','config','templates'].forEach(t=>{
    $('#page-'+t).classList.toggle('hide', t!==name);
    $('#tab-'+t).classList.toggle('active', t===name);
  });
  if(name==='hist') renderHistory();
  if(name==='templates'){ fillPlanSelect(); updatePlanLabels(); }
  window.scrollTo({top:0,behavior:'smooth'});
}
$('#tab-treino').addEventListener('click',()=>showTab('treino'));
$('#tab-historico').addEventListener('click',()=>showTab('hist'));
$('#tab-config').addEventListener('click',()=>showTab('config'));
$('#tab-templates').addEventListener('click',()=>showTab('templates'));

/* ===== Init / PWA ===== */
load1RM(); showTMs(); fillPlanSelect(); updatePlanLabels(); renderAll();
['sn1','cj1','fs1','bs1','dl1','bp1','oh1'].forEach(id=>{ const el=$('#'+id); if(el) el.addEventListener('input',()=>{ showTMs(); renderAll(); }); });

if('serviceWorker' in navigator){
  window.addEventListener('load',()=>navigator.serviceWorker.register('./service-worker.js').catch(console.error));
}
</script>
</body>
</html>
